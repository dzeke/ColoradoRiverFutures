---
title: "Intentionally Created Surplus for Lake Mead: Current Accounts and Next Steps"
author: "David E. Rosenberg"
date: "April 4, 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Description

This is an R Markdown document. Five plots show the current status of the Intentionally Created Surplus (ICS) program for Lake Mead. This program is defined by the 2007 Interim Guidelines and ammended by the 2019 Lower Basin Drought Contingency Plan. The ICS program allows states to voluntarily conserve water, store the water in Lake Mead, get credit, and withdraw the conserved water at a future date under certain restrictions. The DCP mandates certain volumes of conservation (DCP contributions) that increase as Lake Mead level drops. DCP contributions are permanent, states and users lose future access to their contributions.

1. A stacked bar chart compares ICS account balances by state and year. These balances are compared to the overall and individual state max balances allowed by the 2007 Interim Guidelines and 2019 Drought Contigency Plan (DCP). 

2. A stacked bar chart compares annual deposits to and withdraws from ICS accounts by state and year. These deposits and withdrawals are compared to the maximum allowed amounts.

3. A bar plot shows the ratio of ICS account balance to the required DCP contribution at two different Lake Mead water levels. This ratio is the number of years water in the ICS account can be used to make the state's contribution required by the DCP before the ICS account is depleted. This ratio assumes there is no new ICS contributions during that time. The ratios (number of years) fall as Lake Mead level drops and DCP contribution increase. 

4. A bar plot shows the ratio of the ICS withdrawal limit to the DCP obligation at two different Lake Mead water levels. If ICS withdrawal limits are enforced, this ratio represents the fraction of the DCP contribution the state could make from it's ICS account (previously conserved water).

5. A bar plot shows the ratio of the ICS deposit limit to the required DCP contribution at two different Lake Mead water levels. If deposit limits are enforced, this ratio shows how well a state can keep up year-to-year with its required DCP contributions by continuing to conserve, add that water to it's ICS account, then transfer and use the ICS water to meet it's required DCP contribution. Conserving, adding to one's ICS account, and transfering to make a DCP contribution is preferred to a direct DCP contribution. This approach is preferred because water conserved **this** year and credited to the ICS account can be used to meet **next** year's DCP contribution. Should Lake Mead level rise during the year, the state retains access to its ICS water whereas a direct DCP contribution is lost. 

Data from USBR annual accounting reports: https://www.usbr.gov/lc/region/g4000/wtracct.html. Note most recent data is for 2019. 

## Findings **(Recommendations in bold)**

1. The Intetionally Created Surplus program for Lake Mead is popular and well used (Figures 1 and 2).
2. As of 2019, Arizona, California, and Nevada have saved and deposited ~2.3 million acre feet (MAF) of the 2.7 MAF maximum limit (Figure 1). **The states should raise their individual and combined maximum limit immediately to allow states to conserve and store more water in Lake Mead.**
3. When Lake Mead falls below 1,090 feet, California and Nevada are well positioned to convert and use their ICS balance to make their DCP contributions for several years (Figure 3). During this time, both states can continue to deposit water in their ICS accounts to make future DCP contributions and obligations (Figures 4 and 5).
4. At a Lake Mead Level of 1,045 feet, Arizona's ICS balance of 474,000 acre-feet will only cover 74% of its 640,000 acre-feet DCP obligation (Figure 3).
5. Additionally, Arizona's ICS withdrawal and deposit limits prevent the state from using ICS to keep pace with its DCP contributions (Figures 4 and 5). 
6. If Lake Mead level stays below 1,090 feet for multiple years, Arizona will quickly exhaust its ICS account balance (Figure 3 and be forced to make direct DCP contributions each and every year.
7. Both the Interim Guidelines (2007) and the DCP (2019) allow states to make ICS and DCP contributions on behalf of another state. **Once the DCP triggers and Arizona exhausts it's ICS account balance (in less than 1 year)(Figure 3), Arizona could buy and convert ICS water from California or Nevada to meet it's required DCP contribution amounts.**
8. The 2019 DCP does not specify what happens to ICS water once a state uses its' ICS water for a DCP contribution (called DCP ICS in the 2019 DCP) or makes a direct DCP contribution. Physically, the water stays in Lake Mead, same as when a state contributed to its ICS account. 9. To correct this omission, administratively **I recommend to transfer DCP ICS water and direct DCP contributions to a new, separate, system account that is no longer accessible by states or users.** This system water should be managed by a Lower Basin commission whose members are the Lower Basin states, representatives of environmental groups, First Nations, and other under-represented or disadvantaged groups that have historically been excluded from Colorado River decision making. Once Lake Mead rises to a certain level, this system water could be used for purposes that benefit the entire Lower Colorado River system. Example system purposes that benefit the entire Lower Colorado River system could include occasional pulse floods to the Colorado River delta, deliveries to bolster the Salton Sea level, or deliveries to under-represented or disadvantaged groups. The amount of water in the system account will depend on the ICS account balances that states and users convert and use to make their DCP contributions plus the volumes states and users directly contribute to meet their DCP obligations. The Lake Mead level that triggers and allows system releaseses from Lake Mead should be lower than the lake level that states and users are allowed to withdraw from their ICS accounts. Like ICS accounts, there should be a cap (limit) on the annual withdrawal amount from the system account. 

## Requested Citation
David E. Rosenberg (2021), "Intentionally Created Surplus for Lake Mead: Current Accounts and Next Steps." Utah State University. Logan, Utah. https://github.com/dzeke/ColoradoRiverFutures/tree/master/ICS

```{r ICSplot, echo=FALSE, warning=FALSE, message=FALSE}

# ICS-Plots.r
#
# Make stacked bar graph of state Intentionally Created Surplus holdings by year
#
# Data is USBR Water Accounting Reports: https://www.usbr.gov/lc/region/g4000/wtracct.html in source Excel file
# Please report bugs/feedback to:
#
# Updated June 23, 2020 to include annual deposits and withdraws as year-to-year differnces
#
# Updated April 4, 2021 to look at ICS to DCP conversion

#
# David E. Rosenberg
# April 4, 2021
# 
# Utah State University
# david.rosenberg@usu.edu

rm(list = ls())  #Clear history

# Load required libraies

if (!require(tidyverse)) { 
  install.packages("tidyverse", repos="https://cran.cnr.berkeley.edu/", verbose = TRUE) 
  library(tidyverse) 
}

if (!require(readxl)) { 
  install.packages("readxl", repos="http://cran.r-project.org") 
  library(readxl) 
}

  
if (!require(RColorBrewer)) { 
  install.packages("RColorBrewer",repos="http://cran.r-project.org") 
  library(RColorBrewer) # 
}

if (!require(dplyr)) { 
  install.packages("dplyr",repos="http://cran.r-project.org") 
  library(dplyr) # 
}

if (!require(expss)) { 
  install.packages("expss",repos="http://cran.r-project.org") 
  library(expss) # 
}

if (!require(reshape2)) { 
  install.packages("reshape2", repos="http://cran.r-project.org") 
  library(reshape2) 
}

if (!require(pracma)) { 
  install.packages("pracma", repos="http://cran.r-project.org") 
  library(pracma) 
}

if (!require(lubridate)) { 
  install.packages("lubridate", repos="http://cran.r-project.org") 
  library(lubridate) 
}

if (!require(directlabels)) { 
  install.packages("directlabels", repo="http://cran.r-project.org")
  library(directlabels) 
}

if (!require(plyr)) { 
  install.packages("plyr", repo="http://cran.r-project.org")
  library(plyr) 
}

# if (!require(ggplot)) { 
#   install.packages("ggPlot", repo="http://cran.r-project.org", dependencies = T)
#   library(ggplot) 
# }

if (!require(stringr)) { 
  install.packages("stringr", repo="http://cran.r-project.org")
  library(stringr) 
}



# Load Data

# Read in state balances each year
sExcelFile <- 'IntentionallyCreatedSurplus-Summary.xlsx'
dfICSBalance <- read_excel(sExcelFile, sheet = "Sheet1",  range = "B6:F16")
dfICStoDCP <- read_excel(sExcelFile, sheet = "ICStoDCP",  range = "A2:M14")
dfLimits <- read_excel(sExcelFile, sheet = "Sheet1",  range = "A22:E25")

#Read in max balance
nMaxBalance <- read_excel(sExcelFile, sheet = "Sheet1",  range = "A22:E25")
#create a data frame
dfMaxBalance <- data.frame(Year=dfICSBalance$Year, MaxBal = nMaxBalance$Total[2])

#Read in max deposit per year
dfMaxAnnualAmounts <- data.frame(Year=dfICSBalance$Year, MaxDeposit = nMaxBalance$Total[1], MaxWithdraw = nMaxBalance$Total[3])

cColNames <- colnames(dfICSBalance)

#Melt the data so state columns become a variable
dfICSBalanceMelt <- melt(data = dfICSBalance,id.vars = "Year", measure.vars = cColNames[1:3])

palBlues <- brewer.pal(9, "Blues")

#Plot #1. Stacked bar chart of account balance by state by year. Add individual state limits as secondary y axis
# Prepare state limits as a cumulative amount
cColNamesLimits <- colnames(dfLimits)
dfLimitsMelt <- melt(data=dfLimits, id.vars="New levels with DCP", measure.vars = cColNamesLimits[2:5]) 
dfMaxBalanceCum = dfLimitsMelt %>% filter(`New levels with DCP` == "Max Balance (AF)", variable != 'Total')
#Reorder so Arizona is on top
dfMaxBalanceCum$Order <- c(3,2,1)
dfMaxBalanceCum <- dfMaxBalanceCum[order(dfMaxBalanceCum$Order),]
#Calculate the cumulative total
dfMaxBalanceCum$CumVal <- cumsum(dfMaxBalanceCum$value)
#Replace the Arizona label
dfMaxBalanceCum$StateAsChar <- as.character(dfMaxBalanceCum$variable)
dfMaxBalanceCum$StateAsChar[3] <- "Total/Arizona"

```

# Figure 1. Account balances
```{r ICSFig1, echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  
  geom_bar(data=dfICSBalanceMelt, aes(fill=variable,y=value/1e6,x=Year),position="stack", stat="identity") +
  geom_line(data=dfMaxBalance, aes(color="Max Balance", y=MaxBal/1e6,x=Year), size=2) +
  
  scale_fill_manual(name="Guide1",values = c(palBlues[3],palBlues[6],palBlues[9]),breaks=cColNames[1:3]) +
  scale_color_manual(name="Guide2", values=c("Black")) +
  
  scale_x_continuous(breaks=seq(min(dfICSBalanceMelt$Year),max(dfICSBalanceMelt$Year),by=2),labels=seq(min(dfICSBalanceMelt$Year),max(dfICSBalanceMelt$Year),by=2)) +
  
  #Secondary scale with total max balance
  #scale_y_continuous(breaks=seq(0,3,by=1),labels=seq(0,3,by=1), sec.axis = sec_axis(~. +0, name = "", breaks = c(nMaxBalance$Total[2])/1e6, labels = c("Max Balance"))) +
  
  #Secondary scale with individual state max balances
  scale_y_continuous(breaks=seq(0,3,by=1),labels=seq(0,3,by=1), sec.axis = sec_axis(~. +0, name = "Maximum Balances", breaks = dfMaxBalanceCum$CumVal/1e6, labels = dfMaxBalanceCum$StateAsChar)) +
  
 
  guides(fill = guide_legend(keywidth = 1, keyheight = 1), color=FALSE) +
  
  
  theme_bw() +
  
  labs(x="", y="Intentionally Created Surplus\nAccount Balance\n(MAF)") +
  theme(text = element_text(size=20),  legend.title = element_blank(), 
          legend.text=element_text(size=14),
          legend.position= c(0.2,0.8))

```

# Figure 2. Deposits and Withdrawals
```{r ICSFig2, echo=FALSE, warning=FALSE, message=FALSE}
  

#Plot #2. Stacked bar chart of deposits to ICS accounts by state by year

#Calcualte deposits each year the differences by year
dfICSDeposit <- data.frame(-diff(as.matrix(dfICSBalance)))
#Put the correct year back in
dfICSDeposit$Year <- dfICSBalance$Year[1:nrow(dfICSDeposit)]
#Melt the data so state columns become a variable
dfICSDepositMelt <- melt(data = dfICSDeposit,id.vars = "Year", measure.vars = cColNames[1:3])

ggplot() +
  
  geom_bar(data=dfICSDepositMelt, aes(fill=variable,y=value/1e6,x=Year),position="stack", stat="identity") +
  geom_line(data=dfMaxAnnualAmounts, aes(y=MaxDeposit/1e6,x=Year), size=2) +
  geom_line(data=dfMaxAnnualAmounts, aes(color="Max Withdrawal", y=-MaxWithdraw/1e6,x=Year), size=2) +
  
  scale_fill_manual(name="Guide1",values = c(palBlues[3],palBlues[6],palBlues[9]),breaks=cColNames[1:3]) +
  scale_color_manual(name="Guide2", values=c("Black","Black")) +
  
  scale_x_continuous(breaks=seq(min(dfICSDepositMelt$Year),max(dfICSDepositMelt$Year),by=2),labels=seq(min(dfICSDepositMelt$Year),max(dfICSDepositMelt$Year),by=2)) +
  scale_y_continuous(sec.axis = sec_axis(~. +0, name = "", breaks = c(nMaxBalance$Total[1],-nMaxBalance$Total[3])/1e6, labels = c("Max Deposit","Max Withdraw"))) +
  
  #scale_x_continuous(breaks = c(0,5,10,15,20,25),labels=c(0,5,10,15, 20,25), limits = c(0,as.numeric(dfMaxStor %>% filter(Reservoir %in% c("Mead")) %>% select(Volume))),
  #                  sec.axis = sec_axis(~. +0, name = "Mead Level (feet)", breaks = dfMeadPoolsPlot$stor_maf, labels = dfMeadPoolsPlot$label)) +
  
  guides(fill = guide_legend(keywidth = 1, keyheight = 1), color = FALSE) +
  
  
  theme_bw() +
  
  labs(x="", y="Transaction Amount\n(MAF per year)") +
  theme(text = element_text(size=20),  legend.title = element_blank(), legend.text=element_text(size=14),
        legend.position= c(1.25,0.5))


```

# Figure 3. Years 2019 ICS balance can fund an ongoing DCP obligation
```{r ICSFig3, echo=FALSE, warning=FALSE, message=FALSE}


# Plot Years ICS balance can fund DCP obligation
# Ratio of ICS balance to DCP obligation (Years)
dfICStoDCP$ElevationText <- paste(dfICStoDCP$`Mead Elevation (ft)`, "feet")
cColNamesICStoDCP <- colnames(dfICStoDCP)

dfICStoDCPMelt <- melt(data = dfICStoDCP,id.vars = "ElevationText", measure.vars = cColNamesICStoDCP[5:7])

ggplot(data=dfICStoDCPMelt %>% filter((ElevationText == "1025 feet") | (ElevationText == "1045 feet") )) +
  
  geom_bar(aes(fill=variable,y=value,x=variable), position=position_dodge(), stat="identity") +

  scale_fill_manual(name="Guide1",values = c(palBlues[3],palBlues[6],palBlues[9]),breaks=cColNamesICStoDCP[5:7], labels = cColNames[1:3]) +

  scale_x_discrete(labels = cColNames[1:3]) +

  facet_wrap( ~ ElevationText) +
  
   guides(fill = guide_legend(keywidth = 1, keyheight = 1), color = FALSE) +

  theme_bw() +
  
  labs(x="", y="Years 2019 ICS balance can fund\nDCP obligation") +
  theme(text = element_text(size=18),  legend.title = element_blank(), legend.text=element_text(size=18),
        legend.position= "none")

```

# Figure 4. Ratio of ICS max withdrawal limit to DCP obligation.
## States less than 100% (red dashed) will need to implement conservation immediately and make direct DCP contributions.
```{r ICSFig4, echo=FALSE, warning=FALSE, message=FALSE}


### Ratio of ICS max withdrawal to DCP obligation
dfICStoDCPMeltMaxWithdrawal <- melt(data = dfICStoDCP,id.vars = "ElevationText", measure.vars = cColNamesICStoDCP[8:10])

ggplot(data=dfICStoDCPMeltMaxWithdrawal %>% filter((ElevationText == "1025 feet") | (ElevationText == "1045 feet") )) +
  
  geom_bar(aes(fill=variable,y=value,x=variable), position=position_dodge(), stat="identity") +

   #Add a horizontal line for 100%
  geom_hline(yintercept = 1,linetype="dashed",color="red",size = 0.75) +
  
  
  scale_fill_manual(name="Guide1",values = c(palBlues[3],palBlues[6],palBlues[9]),breaks=cColNamesICStoDCP[8:10], labels = cColNames[1:3]) +

  scale_x_discrete(labels = cColNames[1:3]) +

  scale_y_continuous(labels = scales::percent) + 
 
  facet_wrap( ~ ElevationText) +
  
  guides(fill = guide_legend(keywidth = 1, keyheight = 1), color = FALSE) +
  
  
  theme_bw() +
  
  labs(x="", y="Ratio of ICS max withdrawal\nto DCP obligation") +
  theme(text = element_text(size=18),  legend.title = element_blank(), legend.text=element_text(size=18),
        legend.position= "none")


```

# Figure 5. Ratio of ICS max deposit to DCP obligation
## States less than 100% (dashed red line) will likely require help from other users to make their ongoing DCP contributions.
```{r ICSFig5, echo=FALSE, warning=FALSE, message=FALSE}


### Ratio of ICS max deposit to DCP obligation
dfICStoDCPMeltMaxDeposit <- melt(data = dfICStoDCP,id.vars = "ElevationText", measure.vars = cColNamesICStoDCP[11:13])

ggplot(data=dfICStoDCPMeltMaxDeposit %>% filter((ElevationText == "1025 feet") | (ElevationText == "1045 feet") )) +
  
  geom_bar(aes(fill=variable,y=value,x=variable), position=position_dodge(), stat="identity") +
  
  scale_fill_manual(name="Guide1",values = c(palBlues[3],palBlues[6],palBlues[9]),breaks=cColNamesICStoDCP[11:13], labels = cColNames[1:3]) +
  #Add a horizontal line for 100%
  geom_hline(yintercept = 1,linetype="dashed",color="red",size = 0.75) +
  #scale_color_manual(name="Guide2", values=c("Black","Black")) +
  
  #scale_fill_continuous(name="Guide1",values = c(palBlues[6],palBlues[9])) +
  
  scale_x_discrete(labels = cColNames[1:3]) +
  #scale_x_continuous(breaks=seq(min(dfICSDepositMelt$Year),max(dfICSDepositMelt$Year),by=2),labels=seq(min(dfICSDepositMelt$Year),max(dfICSDepositMelt$Year),by=2)) +
  scale_y_continuous(labels = scales::percent) + 
  
  facet_wrap( ~ ElevationText) +
  
  guides(fill = guide_legend(keywidth = 1, keyheight = 1), color = FALSE) +
  
  
  theme_bw() +
  
  labs(x="", y="Ratio of ICS max deposit\nto DCP obligation") +
  theme(text = element_text(size=18),  legend.title = element_blank(), legend.text=element_text(size=18),
        legend.position= "none")

```